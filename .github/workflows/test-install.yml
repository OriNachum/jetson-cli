name: Test Installation

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  test-pip-install:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, '3.10', 3.11, 3.12]

    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install from PyPI
      run: |
        pip install jetson-jolt

    - name: Test CLI functionality
      run: |
        jetson-jolt --version
        jetson-jolt --help
        
        # Test each command help
        jetson-jolt probe --help
        jetson-jolt init --help
        jetson-jolt setup --help
        jetson-jolt configure --help
        jetson-jolt status --help

    - name: Test CLI with platform check disabled
      env:
        JETSON_JOLT_SKIP_PLATFORM_CHECK: "1"
      run: |
        # Test commands that don't require actual Jetson hardware
        jetson-jolt status --format json || echo "Status command tested"
        jetson-jolt --version

  test-docker-install:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker test image
      run: |
        cat > Dockerfile.test << 'EOF'
        FROM python:3.10-slim
        
        # Install system dependencies
        RUN apt-get update && apt-get install -y \
            bash \
            curl \
            sudo \
            && rm -rf /var/lib/apt/lists/*
        
        # Install jetson-jolt
        RUN pip install jetson-jolt
        
        # Test installation
        RUN jetson-jolt --version
        
        # Set environment to skip platform checks
        ENV JETSON_JOLT_SKIP_PLATFORM_CHECK=1
        
        CMD ["jetson-jolt", "--help"]
        EOF
        
        docker build -f Dockerfile.test -t jetson-jolt-test .

    - name: Test Docker installation
      run: |
        docker run --rm jetson-jolt-test jetson-jolt --version
        docker run --rm jetson-jolt-test jetson-jolt --help

  notify-success:
    needs: [test-pip-install, test-docker-install]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: Notify Success
      run: |
        echo "âœ… All installation tests passed!"
        echo "jetson-jolt is ready for users to install via: pip install jetson-jolt"